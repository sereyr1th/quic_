# Caddy Configuration for QUIC/HTTP3 Load Balancing
# Supports connection migration and advanced QUIC-LB features

{
	# Global options
	auto_https on
	servers {
		# Enable HTTP/3 with optimal settings
		protocol {
			experimental_http3
			allow_h2c
		}
	}
}

# Main load balancer endpoint
moodle-itc.duckdns.org {
	# Enable HTTP/3 and QUIC
	protocols h1 h2 h3
	
	# Advanced load balancing with health checks
	reverse_proxy {
		# Multiple backend instances
		to localhost:8080 localhost:8081 localhost:8082
		
		# Load balancing policy
		lb_policy round_robin
		
		# Health checks for connection migration
		health_uri /health
		health_interval 10s
		health_timeout 5s
		health_status 200
		
		# QUIC-specific headers
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-For {remote_host}
		header_up X-Real-IP {remote_host}
		
		# Connection migration support
		header_up Connection-Migration-Supported "true"
		header_up QUIC-Version "1"
		
		# Fail-over configuration
		fail_duration 30s
		max_fails 3
		unhealthy_status 5xx
	}
	
	# Logging for monitoring
	log {
		output file /var/log/caddy/quic-lb.log
		format json
		level INFO
	}
	
	# CORS headers for web clients
	header {
		Access-Control-Allow-Origin "*"
		Access-Control-Allow-Methods "GET, POST, OPTIONS"
		Access-Control-Allow-Headers "Origin, Content-Type, Accept, Authorization"
	}
	
	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Alt-Svc `h3=":443"; ma=86400`
	}
}

# Metrics endpoint (separate from main traffic)
metrics.moodle-itc.duckdns.org {
	protocols h1 h2 h3
	reverse_proxy localhost:9090
	
	# Basic auth for metrics
	basicauth {
		admin $2a$14$hNKNqz8x8mIKSN.UaHvnh.7w7XsIjPsT3QFwEfkfM7nJXYZ8kxvPu
	}
}

# Health check endpoint
health.moodle-itc.duckdns.org {
	protocols h1 h2 h3
	respond /health "OK" 200
	
	# Detailed health endpoint
	reverse_proxy /health/* localhost:8080
}

# Development/testing configuration
:8443 {
	protocols h1 h2 h3
	
	# Local testing without domain
	reverse_proxy {
		to localhost:8080 localhost:8081 localhost:8082
		lb_policy least_conn
		health_uri /health
		health_interval 5s
	}
	
	# TLS configuration for local testing
	tls internal
}
